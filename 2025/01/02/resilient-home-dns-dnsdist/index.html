<!doctype html><html lang=en><head><title>Building a Resilient Home DNS Setup with DNSdist :: Shantanu Vs The World</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Running Pi-hole or AdGuard Home provides great network-wide ad blocking, but creates a single point of failure. When your DNS server crashes or needs maintenance, your entire network loses DNS resolution. I had this problem and thus far had chosen to do a sub-optimal solution of using both AdGuard DNS as well as an upstream Google DNS server in my internet gateway. dnsmasq running on the gateway that manages DNS requests from all the clients in my network has no concept of a failover DNS server, or server priorities. It dispatches requests to all the servers it has configured, and ideally should honor whichever servers responds first.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://shantanugoel.com/2025/01/02/resilient-home-dns-dnsdist/><script async src="https://www.googletagmanager.com/gtag/js?id=G-5CKCTSFXW8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5CKCTSFXW8")}</script><link rel=stylesheet href=https://shantanugoel.com/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css><link rel=stylesheet href=https://shantanugoel.com/css/code.min.00125962708925857e7b66dbc58391d55be1191a3d0ce2034de8c9cd2c481c36.css><link rel=stylesheet href=https://shantanugoel.com/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css><link rel=stylesheet href=https://shantanugoel.com/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css><link rel=stylesheet href=https://shantanugoel.com/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://shantanugoel.com/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css><link rel=stylesheet href=https://shantanugoel.com/css/main.min.fe8dc560fccb53a458b0db19ccb7b265764ac46b68596b7e099c6793054dd457.css><link rel=stylesheet href=https://shantanugoel.com/css/menu.min.83637a90d903026bc280d3f82f96ceb06c5fc72b7c1a8d686afb5bbf818a29f7.css><link rel=stylesheet href=https://shantanugoel.com/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css><link rel=stylesheet href=https://shantanugoel.com/css/post.min.fc74ca360273c1d828da3c02b8174eba435607b369d98418ccc6f2243cd4e75d.css><link rel=stylesheet href=https://shantanugoel.com/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css><link rel=stylesheet href=https://shantanugoel.com/css/syntax.min.cc789ed9377260d7949ea4c18781fc58959a89287210fe4edbff44ebfc1511b6.css><link rel=stylesheet href=https://shantanugoel.com/css/terminal.min.dd0bf9c7cacb24c1b0184f52f1869b274e06689557468cc7030ccf632328eb97.css><link rel=stylesheet href=https://shantanugoel.com/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=https://shantanugoel.com/favicon.png><link rel=apple-touch-icon href=https://shantanugoel.com/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Building a Resilient Home DNS Setup with DNSdist"><meta property="og:description" content="Running Pi-hole or AdGuard Home provides great network-wide ad blocking, but creates a single point of failure. When your DNS server crashes or needs maintenance, your entire network loses DNS resolution. I had this problem and thus far had chosen to do a sub-optimal solution of using both AdGuard DNS as well as an upstream Google DNS server in my internet gateway. dnsmasq running on the gateway that manages DNS requests from all the clients in my network has no concept of a failover DNS server, or server priorities. It dispatches requests to all the servers it has configured, and ideally should honor whichever servers responds first.
"><meta property="og:url" content="https://shantanugoel.com/2025/01/02/resilient-home-dns-dnsdist/"><meta property="og:site_name" content="Shantanu Vs The World"><meta property="og:image" content="https://shantanugoel.com/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-01-02 00:46:31 +0530 +0530"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Shantanu vs The World</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;‚ñæ</li><li><ul class=menu__dropdown><li><a href=https://github.com/shantanugoel/>üíª</a></li><li><a href=https://x.com/shantanugoel/>üê§</a></li><li><a href=/>/blog</a></li><li><a href=/notes>/notes</a></li><li><a href=/about>/about</a></li><li><a href=/archives>/archives</a></li><li><a href=/fun>/fun</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=https://github.com/shantanugoel/>üíª</a></li><li><a href=https://x.com/shantanugoel/>üê§</a></li><li><a href=/>/blog</a></li><li><a href=/notes>/notes</a></li><li><a href=/about>/about</a></li><li><a href=/archives>/archives</a></li><li><a href=/fun>/fun</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://shantanugoel.com/2025/01/02/resilient-home-dns-dnsdist/>Building a Resilient Home DNS Setup with DNSdist</a></h1><div class=post-meta><time class=post-date>2025-01-02</time><span class=post-author>Shantanu Goel</span></div><div class=post-content><div><p>Running Pi-hole or AdGuard Home provides great network-wide ad blocking, but creates a single point of failure. When your DNS server crashes or needs maintenance, your entire network loses DNS resolution. I had this problem and thus far had chosen to do a sub-optimal solution of using both AdGuard DNS as well as an upstream Google DNS server in my internet gateway. <code>dnsmasq</code> running on the gateway that manages DNS requests from all the clients in my network has no concept of a failover DNS server, or server priorities. It dispatches requests to all the servers it has configured, and <em>ideally</em> should honor whichever servers responds first.</p><p>This worked, sort of, but I often had requests leaking through to upstream servers. I recently found out about <code>dnsdist</code> and used that to fix it.</p><p>We will use dnsdist as a DNS load balance to create a failover setup. It will:</p><ul><li>Route DNS queries to your primary ad-blocking DNS server</li><li>Automatically failover to backup DNS server if the primary fails</li><li>Switch back once the primary recovers</li></ul><p>Requirements:</p><ul><li>Pi-hole/AdGuard Home already set up</li><li>A device to run dnsdist (Raspberry Pi or any Linux system, but it should be different than the one running Pi-hole/AdGuard Home)</li><li>Basic command line knowledge</li></ul><p>Steps:</p><ol><li>Install dnsdist (Below command assumes debian or derivatives. Use corresponding command for other distros)</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update <span style=color:#f92672>&amp;&amp;</span> sudo apt install dnsdist
</span></span></code></pre></div><ol start=2><li>Create a minimal config file at <code>/etc/dnsdist/dnsdist.conf</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>-- Define DNS servers
</span></span><span style=display:flex><span>newServer<span style=color:#f92672>({</span>address<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;192.168.1.10:53&#34;</span>, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;primary&#34;</span><span style=color:#f92672>})</span>     -- Pi-hole/AdGuard
</span></span><span style=display:flex><span>newServer<span style=color:#f92672>({</span>address<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;9.9.9.9:53&#34;</span>, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;quad9&#34;</span><span style=color:#f92672>})</span>           -- Backup DNS <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>newServer<span style=color:#f92672>({</span>address<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.1.1.1:53&#34;</span>, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cloudflare&#34;</span><span style=color:#f92672>})</span>      -- Backup DNS <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-- Basic settings
</span></span><span style=display:flex><span>setLocal<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;0.0.0.0:53&#34;</span><span style=color:#f92672>)</span>           -- Listen on all interfaces
</span></span><span style=display:flex><span>setACL<span style=color:#f92672>({</span><span style=color:#e6db74>&#39;0.0.0.0/0&#39;</span><span style=color:#f92672>})</span>           -- Allow queries from anywhere
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-- Health checking
</span></span><span style=display:flex><span>setServerPolicy<span style=color:#f92672>(</span>firstAvailable<span style=color:#f92672>)</span>  -- Use first available server
</span></span></code></pre></div><p>2a. There are a lot of optional settings available to further customize things like health check interval, what kind of checks to use, how to determine a failover scenario, etc. You can check dnsdist man page for more details.</p><ol start=2><li>Enable dnsdist service</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl enable --now dnsdist
</span></span></code></pre></div><ol start=4><li>Update your router&rsquo;s DHCP settings to use the dnsdist server IP as the primary DNS, and the pi-hole/AdGuard DNS as the secondary DNS. Now, as long as both of them don&rsquo;t go down at the same time, you will have a working DNS setup.</li></ol></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>¬© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>