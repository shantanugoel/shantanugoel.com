<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Storage and Retrieval
  #


  Data Structures that power your DB
  #

log -> In DB context, refers to &ldquo;an append only sequence of records&rdquo;.
Many DBs use a log to store data (but need additional processing e.g. concurrency control, reclaiming disk space, handling errors etc)
Writing data in a log is fast since it only appends to the end of the file but reading can be slow since it requires scanning the entire file, and hence DBs need an index."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://shantanugoel.com/notes/books/ddia/chapter-3/"><meta property="og:site_name" content="Shantanu's Notesverse"><meta property="og:title" content="Chapter 3: Storage and Retrieval"><meta property="og:description" content="Storage and Retrieval # Data Structures that power your DB # log -> In DB context, refers to “an append only sequence of records”.
Many DBs use a log to store data (but need additional processing e.g. concurrency control, reclaiming disk space, handling errors etc)
Writing data in a log is fast since it only appends to the end of the file but reading can be slow since it requires scanning the entire file, and hence DBs need an index."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="books"><title>Chapter 3: Storage and Retrieval | Shantanu's Notesverse</title>
<link rel=icon href=/notes/favicon.png><link rel=manifest href=/notes/manifest.json><link rel=canonical href=https://shantanugoel.com/notes/books/ddia/chapter-3/><link rel=stylesheet href=/notes/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/notes/fuse.min.js></script><script defer src=/notes/en.search.min.d8cc77086cfe8689b76b9dabc9fcd00152dbb02bab8451c4ef808f6764fbf60b.js integrity="sha256-2Mx3CGz+hom3a52ryfzQAVLbsCurhFHE74CPZ2T79gs=" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-5CKCTSFXW8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5CKCTSFXW8")}</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/notes/><span>Shantanu's Notesverse</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=https://shantanugoel.com target=_blank rel=noopener>Blog</a></li></ul><ul><li><a href=/notes/books/>Books</a><ul><li><input type=checkbox id=section-e9d75868e6793f3a69534dc012457820 class=toggle checked>
<label for=section-e9d75868e6793f3a69534dc012457820 class="flex justify-between"><a href=/notes/books/ddia/>Designing Data-Intensive Applications</a></label><ul><li><a href=/notes/books/ddia/chapter-1/>Chapter 1: Foundations of Data Systems</a></li><li><a href=/notes/books/ddia/chapter-2/>Chapter 2: Data Models and Query Languages</a></li><li><a href=/notes/books/ddia/chapter-3/ class=active>Chapter 3: Storage and Retrieval</a></li></ul></li></ul></li><li><a href=/notes/travel/>Travel</a><ul><li><a href=/notes/travel/china/china/>China</a></li><li><a href=/notes/travel/hongkong/hk/>Hong Kong</a></li><li><a href=/notes/travel/japan/japan/>Japan</a></li></ul></li><li><a href=/notes/braindump/>Braindump</a><ul><li><a href=/notes/braindump/hugo-multiple-themes/>Multiple Hugo Themes For Different Paths In Same Site</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/notes/svg/menu.svg class=book-icon alt=Menu></label><h3>Chapter 3: Storage and Retrieval</h3><label for=toc-control><img src=/notes/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#data-structures-that-power-your-db>Data Structures that power your DB</a><ul><li><a href=#hash-indexes>Hash Indexes</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=storage-and-retrieval>Storage and Retrieval
<a class=anchor href=#storage-and-retrieval>#</a></h1><h2 id=data-structures-that-power-your-db>Data Structures that power your DB
<a class=anchor href=#data-structures-that-power-your-db>#</a></h2><p><strong>log</strong> -> In DB context, refers to &ldquo;an append only sequence of records&rdquo;.</p><p>Many DBs use a log to store data (but need additional processing e.g. concurrency control, reclaiming disk space, handling errors etc)</p><p>Writing data in a log is fast since it only appends to the end of the file but reading can be slow since it requires scanning the entire file, and hence DBs need an <strong>index</strong>.</p><p>An index slows down writes because it needs to be updated every time the data changes, so not everything is indexed by default and needs intuition by the developer to choose the right indexes.</p><h3 id=hash-indexes>Hash Indexes
<a class=anchor href=#hash-indexes>#</a></h3><p>Simplest strategy:</p><ul><li>Keep an in-memory hash map where every key is mapped to a byte offset in the data file where the value can be found</li><li>When a new key-value pair is appended to the file, add or update the hash map with the new offset</li><li>To look up a value, get the offset from the hash map, seek to that position in the data file, and read the value</li></ul><p>This is used by <strong>Bitcask</strong>, the default storage engine for <strong>Riak</strong>. This is suited for situations where values for existing keys are updated frequently since there are a lot of writes but not many distinct keys, so it&rsquo;s feasible to keep all keys in memory.</p><p><strong>Compaction</strong> - A strategy to reclaim disk space:</p><ul><li>Break the log into segments of a certain size and save them in separate files</li><li>Perform compaction on each file, i.e., throw away duplicate keys and keep only most recent update for each key</li><li>Since segment files become smaller with compaction, they can be merged together to form a new segment file (Old segment files can be then discarded)</li><li>This can be done in the background as an offline batch processing task so there&rsquo;s no perf hit to live workloads</li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#data-structures-that-power-your-db>Data Structures that power your DB</a><ul><li><a href=#hash-indexes>Hash Indexes</a></li></ul></li></ul></nav></div></aside></main></body></html>