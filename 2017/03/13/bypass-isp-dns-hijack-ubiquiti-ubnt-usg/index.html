<!doctype html><html lang=en><head><title>Bypass ISP DNS hijack by changing DNS port on Ubiquiti USG router :: Shantanu Vs The World</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The Background We talked earlier about how certain ISPs block websites by using DNS hijack methods and I had recommended using DNSCrypt to bypass it. Well, as part of my home network overhaul, I moved over from the consumer grade (but still decent enough) Asus router over to Ubiquiti stack which, among other things, lead me to use their &ldquo;Unify Security Gateway (USG)&rdquo; as the router. Now, this router is pretty decent and is running Ubiquiti&rsquo;s EdgeOS (derived from Vyatta OS, which in turn is based on linux/debian). You can install and tweak a lot of stuff through command line if you&rsquo;d like but alas there&rsquo;s no dnscrypt-proxy available for it.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://shantanugoel.com/2017/03/13/bypass-isp-dns-hijack-ubiquiti-ubnt-usg/><script async src="https://www.googletagmanager.com/gtag/js?id=G-5CKCTSFXW8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5CKCTSFXW8")}</script><link rel=stylesheet href=https://shantanugoel.com/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css><link rel=stylesheet href=https://shantanugoel.com/css/code.min.628b83582b7e3ce5fbec137a2c22e9dd728066c2a25433bc713f3c02f60e9d0d.css><link rel=stylesheet href=https://shantanugoel.com/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css><link rel=stylesheet href=https://shantanugoel.com/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css><link rel=stylesheet href=https://shantanugoel.com/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://shantanugoel.com/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css><link rel=stylesheet href=https://shantanugoel.com/css/main.min.89e1ce68f5ae8bacb023257282bc8b962c837342140e7c122c46b31a39bebc5f.css><link rel=stylesheet href=https://shantanugoel.com/css/menu.min.036f7f3c01b34c968c3c11f671600515ea8247bdb345694d1c244c92edc67a24.css><link rel=stylesheet href=https://shantanugoel.com/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css><link rel=stylesheet href=https://shantanugoel.com/css/post.min.aee3bce7973384e650a306992c941e09dc6a1e22f04443c00fefb71a7e9484d2.css><link rel=stylesheet href=https://shantanugoel.com/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css><link rel=stylesheet href=https://shantanugoel.com/css/syntax.min.28d2d93e80d9fc88428d8438285537c167ec74544ef064da1cc0313254904b54.css><link rel=stylesheet href=https://shantanugoel.com/css/terminal.min.4dc14b43e2ad0b40e86536fbd75d5ba1ab079aa1b5da8271eced09310dfa1242.css><link rel=stylesheet href=https://shantanugoel.com/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=https://shantanugoel.com/favicon.png><link rel=apple-touch-icon href=https://shantanugoel.com/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Bypass ISP DNS hijack by changing DNS port on Ubiquiti USG router"><meta property="og:description" content="The Background We talked earlier about how certain ISPs block websites by using DNS hijack methods and I had recommended using DNSCrypt to bypass it. Well, as part of my home network overhaul, I moved over from the consumer grade (but still decent enough) Asus router over to Ubiquiti stack which, among other things, lead me to use their &ldquo;Unify Security Gateway (USG)&rdquo; as the router. Now, this router is pretty decent and is running Ubiquiti&rsquo;s EdgeOS (derived from Vyatta OS, which in turn is based on linux/debian). You can install and tweak a lot of stuff through command line if you&rsquo;d like but alas there&rsquo;s no dnscrypt-proxy available for it.
"><meta property="og:url" content="https://shantanugoel.com/2017/03/13/bypass-isp-dns-hijack-ubiquiti-ubnt-usg/"><meta property="og:site_name" content="Shantanu Vs The World"><meta property="og:image" content="https://shantanugoel.com/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2017-03-13 16:46:24 +0530 +0530"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Shantanu vs The World</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;‚ñæ</li><li><ul class=menu__dropdown><li><a href=https://github.com/shantanugoel/>üíª</a></li><li><a href=https://x.com/shantanugoel/>üê§</a></li><li><a href=/>/blog</a></li><li><a href=/notes>/notes</a></li><li><a href=/about>/about</a></li><li><a href=/archives>/archives</a></li><li><a href=/fun>/fun</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=https://github.com/shantanugoel/>üíª</a></li><li><a href=https://x.com/shantanugoel/>üê§</a></li><li><a href=/>/blog</a></li><li><a href=/notes>/notes</a></li><li><a href=/about>/about</a></li><li><a href=/archives>/archives</a></li><li><a href=/fun>/fun</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://shantanugoel.com/2017/03/13/bypass-isp-dns-hijack-ubiquiti-ubnt-usg/>Bypass ISP DNS hijack by changing DNS port on Ubiquiti USG router</a></h1><div class=post-meta><time class=post-date>2017-03-13</time><span class=post-author>Shantanu Goel</span></div><div class=post-content><div><h2 id=the-background>The Background<a href=#the-background class=hanchor arialabel=Anchor>#</a></h2><p>We talked earlier about how certain <a href=/2016/09/17/indian-isp-act-fibernet-blocks-bit-ly-does-dns-hijacking/>ISPs block websites by using DNS hijack methods</a> and I had recommended using DNSCrypt to bypass it. Well, as part of my home network overhaul, I moved over from the consumer grade (but still decent enough) Asus router over to Ubiquiti stack which, among other things, lead me to use their &ldquo;Unify Security Gateway (USG)&rdquo; as the router. Now, this router is pretty decent and is running Ubiquiti&rsquo;s EdgeOS (derived from Vyatta OS, which in turn is based on linux/debian). You can install and tweak a lot of stuff through command line if you&rsquo;d like but alas there&rsquo;s no dnscrypt-proxy available for it.</p><p>I had the below options now to overcome my ISP&rsquo;s DNS hijacking:</p><ol><li><p>Compile dnscrypt manually and use it</p></li><li><p>Run dnscrypt on another server/device internally (maybe my NAS or the ubiquiti cloudkey or something)</p></li><li><p>Use one of the other options I had originally discussed (hosts file, VPN, alternate port)</p></li></ol><p>I rejected the first option as it meant setting up a cross compilation environment just for one program and also it may be hard to keep up in future. The 2nd option wasn&rsquo;t too good either as I didn&rsquo;t want my network infrastructure&rsquo;s basic need of DNS to depend on another device which may not be as resilient due to other regular use. From the other earlier discussed alternatives, I didn&rsquo;t want to do the manual upkeep of hosts file or fall into the expensive/slow/insecure trap of VPNs. So I settled on the next best solution of using an alternate port for my DNS queries, with the hope that the ISP is dumb (or cost conscious) enough to rely only on port number to higjack DNS and not use DPI for it (even though <a href=/2017/01/24/act-fibernet-deep-packet-inspection-blocking-sites/>they do use DPI for at least some types of blocking</a>).</p><h2 id=testing-the-waters>Testing the Waters<a href=#testing-the-waters class=hanchor arialabel=Anchor>#</a></h2><p>First thing was to try whether this would even work or not. So I tried it easily by querying for a blocked torrent site first through ISP&rsquo;s DNS servers, then OpenDNS servers on default DNS port (53) and then Open DNS servers on port 5353 (Yes, OpenDNS responds to dns queries on 5353 as well, fortunately.)</p><figure class=left><img src=/img/2017/03/dns-queries-thumb.jpg></figure><p>In the first 2 attempts, the IP returned was my ISP&rsquo;s hijacked reply (pointing to their own generic server that they use to respond to blocked site requests) but in the last one (using port 5353), the DNS request went unmodified and came back with the real IP of the website. Success!</p><h2 id=configuring-the-usg>Configuring the USG<a href=#configuring-the-usg class=hanchor arialabel=Anchor>#</a></h2><p>So, on to the real deal. USG does have a UI option in the Unify Controller software to set custom DNS servers. However, it takes only IPs and not ports. This is understandable as I found out after going through resolv.conf manpages and several old discussions. resolv.conf&rsquo;s support for alternate ports has been discussed several times and rejected in favor of other system wide solutions.</p><p>I had a thought to use iptables to forward all requests going out to WAN port 53 to port 5353. But, this is like using a shotgun to pop balloons. Firewall solutions like this should be used rarely as they strain the traffic processing as they build up quickly.</p><p>USG uses dnsmasq though, so there was hope. DNSmasq allows to set ports as well for nameservers as per its manpage. So, the problem statement was thus as below:</p><ul><li><p>Don&rsquo;t use resolv.conf at all (to avoid ISP&rsquo;s DNS servers or any other DNS servers leaking traffic onto port 53)</p></li><li><p>Set OpenDNS nameserver ip/port in dnsmasq for all sites (Generally folks use it for specific sites, but the configuration syntax is flexible enough to mould it anyways and we can set it as a generic server too)</p></li></ul><p>There&rsquo;s no UI option for this though, so you&rsquo;ve to drop down to the CLI. Launch an ssh session to the USG ip and use the credentials that you&rsquo;ve set in the unify controller to log in. Then run the below set of commands. The procedure is slightly different from a regular linux box (where you&rsquo;d directly edit dnsmasq.conf) due to the specific nature of config management of ubiquiti devices.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># Switch to configuration mode
</span></span><span style=display:flex><span>$ configure
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Below commands will generate the appropriate dnsmasq.conf automaticall
</span></span><span style=display:flex><span># Don&#39;t use resolve.conf 
</span></span><span style=display:flex><span>$ set service dns forwarding options &#34;no-resolv&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Set the opendns nameserver for all sites
</span></span><span style=display:flex><span>$ set service dns forwarding options &#34;server=208.67.222.222#5353&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Generate the config files, save and exit
</span></span><span style=display:flex><span>$ commit;save;exit
</span></span></code></pre></div><p>Now, you can try browsing (or doing nslookup) for the blocked website and it&rsquo;ll go through succesfully. Note that like all other CLI changes for USG, the above changes can be lost whenever you make some other config change through UI or update USG firmware. To make it persistent across such events, you need to follow the <a href=https://help.ubnt.com/hc/en-us/articles/215458888-UniFi-How-to-further-customize-USG-configuration-with-config-gateway-json>config.gateway json process</a>.</p></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>¬© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>