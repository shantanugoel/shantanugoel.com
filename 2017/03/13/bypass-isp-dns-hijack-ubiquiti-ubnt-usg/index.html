<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Bypass ISP DNS hijack by changing DNS port on Ubiquiti USG router - Shantanu Vs The World</title><meta name=description content="The Background We talked earlier about how certain ISPs block websites by using DNS hijack methods and I had recommended using DNSCrypt to bypass it. Well, as part of my home network overhaul, I moved over from the consumer grade (but still decent enough) Asus router over to Ubiquiti stack which, among other things, lead me to use their &ldquo;Unify Security Gateway (USG)&rdquo; as the router. Now, this router is pretty decent and is running Ubiquiti's EdgeOS (derived from Vyatta OS, which in turn is based on linux/debian)."><meta name=author content="Shantanu Goel"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Shantanu Vs The World","url":"https:\/\/shantanugoel.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/shantanugoel.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/shantanugoel.com","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/shantanugoel.com\/2017\/03\/13\/bypass-isp-dns-hijack-ubiquiti-ubnt-usg\/","name":"Bypass i s p d n s hijack by changing d n s port on ubiquiti u s g router"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Shantanu Goel"},"headline":"Bypass ISP DNS hijack by changing DNS port on Ubiquiti USG router","description":"The Background We talked earlier about how certain ISPs block websites by using DNS hijack methods and I had recommended using DNSCrypt to bypass it. Well, as part of my home network overhaul, I moved over from the consumer grade (but still decent enough) Asus router over to Ubiquiti stack which, among other things, lead me to use their \x26ldquo;Unify Security Gateway (USG)\x26rdquo; as the router. Now, this router is pretty decent and is running Ubiquiti\x27s EdgeOS (derived from Vyatta OS, which in turn is based on linux\/debian).","inLanguage":"en","wordCount":805,"datePublished":"2017-03-13T16:46:24","dateModified":"2017-03-13T16:46:24","image":"https:\/\/shantanugoel.com\/img\/avatar.jpg","keywords":["ACT Fibernet, ubiquiti, dns hijack, security, usg"],"mainEntityOfPage":"https:\/\/shantanugoel.com\/2017\/03\/13\/bypass-isp-dns-hijack-ubiquiti-ubnt-usg\/","publisher":{"@type":"Organization","name":"https:\/\/shantanugoel.com","logo":{"@type":"ImageObject","url":"https:\/\/shantanugoel.com\/img\/avatar.jpg","height":60,"width":60}}}</script><meta property="og:title" content="Bypass ISP DNS hijack by changing DNS port on Ubiquiti USG router"><meta property="og:description" content="The Background We talked earlier about how certain ISPs block websites by using DNS hijack methods and I had recommended using DNSCrypt to bypass it. Well, as part of my home network overhaul, I moved over from the consumer grade (but still decent enough) Asus router over to Ubiquiti stack which, among other things, lead me to use their &ldquo;Unify Security Gateway (USG)&rdquo; as the router. Now, this router is pretty decent and is running Ubiquiti's EdgeOS (derived from Vyatta OS, which in turn is based on linux/debian)."><meta property="og:image" content="https://shantanugoel.com/img/avatar.jpg"><meta property="og:url" content="https://shantanugoel.com/2017/03/13/bypass-isp-dns-hijack-ubiquiti-ubnt-usg/"><meta property="og:type" content="website"><meta property="og:site_name" content="Shantanu Vs The World"><meta name=twitter:title content="Bypass ISP DNS hijack by changing DNS port on Ubiquiti USG router"><meta name=twitter:description content="The Background We talked earlier about how certain ISPs block websites by using DNS hijack methods and I had recommended using DNSCrypt to bypass it. Well, as part of my home network overhaul, I moved â€¦"><meta name=twitter:image content="https://shantanugoel.com/img/avatar.jpg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@shantanugoel"><meta name=twitter:creator content="@shantanugoel"><link href=https://shantanugoel.com/img/avatar.jpg rel=icon type=image/x-icon><meta name=generator content="Hugo 0.62.0"><link rel=alternate href=https://shantanugoel.com/index.xml type=application/rss+xml title="Shantanu Vs The World"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://shantanugoel.com/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://shantanugoel.com/css/syntax.css><link rel=stylesheet href=https://shantanugoel.com/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-3966412-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://shantanugoel.com>Shantanu Vs The World</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a href=https://github.com/shantanugoel/><i class="fab fa-github fa-stack-2x"></i></a></li><li><a href=https://twitter.com/shantanugoel/><i class="fab fa-twitter fa-stack-2x"></i></a></li><li><a title=/blog href=/>/blog</a></li><li><a title=/about href=/about/>/about</a></li><li><a title=/archives href=/archives/>/archives</a></li><li><a title=/categories href=/categories/>/categories</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="Shantanu Vs The World" href=https://shantanugoel.com><img class=avatar-img src=https://shantanugoel.com/img/avatar.jpg alt="Shantanu Vs The World"></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>Bypass ISP DNS hijack by changing DNS port on Ubiquiti USG router</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><h2 id=the-background>The Background</h2><p>We talked earlier about how certain <a href=/2016/09/17/indian-isp-act-fibernet-blocks-bit-ly-does-dns-hijacking/>ISPs block websites by using DNS hijack methods</a> and I had recommended using DNSCrypt to bypass it. Well, as part of my home network overhaul, I moved over from the consumer grade (but still decent enough) Asus router over to Ubiquiti stack which, among other things, lead me to use their &ldquo;Unify Security Gateway (USG)&rdquo; as the router. Now, this router is pretty decent and is running Ubiquiti's EdgeOS (derived from Vyatta OS, which in turn is based on linux/debian). You can install and tweak a lot of stuff through command line if you'd like but alas there's no dnscrypt-proxy available for it.</p><p>I had the below options now to overcome my ISP's DNS hijacking:</p><ol><li><p>Compile dnscrypt manually and use it</p></li><li><p>Run dnscrypt on another server/device internally (maybe my NAS or the ubiquiti cloudkey or something)</p></li><li><p>Use one of the other options I had originally discussed (hosts file, VPN, alternate port)</p></li></ol><p>I rejected the first option as it meant setting up a cross compilation environment just for one program and also it may be hard to keep up in future. The 2nd option wasn't too good either as I didn't want my network infrastructure's basic need of DNS to depend on another device which may not be as resilient due to other regular use. From the other earlier discussed alternatives, I didn't want to do the manual upkeep of hosts file or fall into the expensive/slow/insecure trap of VPNs. So I settled on the next best solution of using an alternate port for my DNS queries, with the hope that the ISP is dumb (or cost conscious) enough to rely only on port number to higjack DNS and not use DPI for it (even though <a href=/2017/01/24/act-fibernet-deep-packet-inspection-blocking-sites/>they do use DPI for at least some types of blocking</a>).</p><h2 id=testing-the-waters>Testing the Waters</h2><p>First thing was to try whether this would even work or not. So I tried it easily by querying for a blocked torrent site first through ISP's DNS servers, then OpenDNS servers on default DNS port (53) and then Open DNS servers on port 5353 (Yes, OpenDNS responds to dns queries on 5353 as well, fortunately.)</p><link rel=stylesheet href=https://shantanugoel.com/css/hugo-easy-gallery.css><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=/img/2017/03/dns-queries-thumb.jpg alt=/img/2017/03/dns-queries-thumb.jpg></div><a href=/img/2017/03/dns-queries.jpg itemprop=contentUrl></a><figcaption><h4>Testing DNS alternate port theory</h4></figcaption></figure></div><p>In the first 2 attempts, the IP returned was my ISP's hijacked reply (pointing to their own generic server that they use to respond to blocked site requests) but in the last one (using port 5353), the DNS request went unmodified and came back with the real IP of the website. Success!</p><h2 id=configuring-the-usg>Configuring the USG</h2><p>So, on to the real deal. USG does have a UI option in the Unify Controller software to set custom DNS servers. However, it takes only IPs and not ports. This is understandable as I found out after going through resolv.conf manpages and several old discussions. resolv.conf's support for alternate ports has been discussed several times and rejected in favor of other system wide solutions.</p><p>I had a thought to use iptables to forward all requests going out to WAN port 53 to port 5353. But, this is like using a shotgun to pop balloons. Firewall solutions like this should be used rarely as they strain the traffic processing as they build up quickly.</p><p>USG uses dnsmasq though, so there was hope. DNSmasq allows to set ports as well for nameservers as per its manpage. So, the problem statement was thus as below:</p><ul><li><p>Don't use resolv.conf at all (to avoid ISP's DNS servers or any other DNS servers leaking traffic onto port 53)</p></li><li><p>Set OpenDNS nameserver ip/port in dnsmasq for all sites (Generally folks use it for specific sites, but the configuration syntax is flexible enough to mould it anyways and we can set it as a generic server too)</p></li></ul><p>There's no UI option for this though, so you've to drop down to the CLI. Launch an ssh session to the USG ip and use the credentials that you've set in the unify controller to log in. Then run the below set of commands. The procedure is slightly different from a regular linux box (where you'd directly edit dnsmasq.conf) due to the specific nature of config management of ubiquiti devices.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># Switch to configuration mode
$ configure

# Below commands will generate the appropriate dnsmasq.conf automaticall
# Don&#39;t use resolve.conf 
$ set service dns forwarding options &#34;no-resolv&#34;

# Set the opendns nameserver for all sites
$ set service dns forwarding options &#34;server=208.67.222.222#5353&#34;

# Generate the config files, save and exit
$ commit;save;exit

</code></pre></div><p>Now, you can try browsing (or doing nslookup) for the blocked website and it'll go through succesfully. Note that like all other CLI changes for USG, the above changes can be lost whenever you make some other config change through UI or update USG firmware. To make it persistent across such events, you need to follow the <a href=https://help.ubnt.com/hc/en-us/articles/215458888-UniFi-How-to-further-customize-USG-configuration-with-config-gateway-json>config.gateway json process</a>.</p><div class=blog-tags><a href=https://shantanugoel.com/tags/act-fibernet/>ACT Fibernet</a>&nbsp;
<a href=https://shantanugoel.com/tags/ubiquiti/>ubiquiti</a>&nbsp;
<a href=https://shantanugoel.com/tags/dns-hijack/>dns hijack</a>&nbsp;
<a href=https://shantanugoel.com/tags/security/>security</a>&nbsp;
<a href=https://shantanugoel.com/tags/usg/>usg</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fshantanugoel.com%2f2017%2f03%2f13%2fbypass-isp-dns-hijack-ubiquiti-ubnt-usg%2f&text=Bypass%20ISP%20DNS%20hijack%20by%20changing%20DNS%20port%20on%20Ubiquiti%20USG%20router&via=shantanugoel" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshantanugoel.com%2f2017%2f03%2f13%2fbypass-isp-dns-hijack-ubiquiti-ubnt-usg%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fshantanugoel.com%2f2017%2f03%2f13%2fbypass-isp-dns-hijack-ubiquiti-ubnt-usg%2f&title=Bypass%20ISP%20DNS%20hijack%20by%20changing%20DNS%20port%20on%20Ubiquiti%20USG%20router" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fshantanugoel.com%2f2017%2f03%2f13%2fbypass-isp-dns-hijack-ubiquiti-ubnt-usg%2f&title=Bypass%20ISP%20DNS%20hijack%20by%20changing%20DNS%20port%20on%20Ubiquiti%20USG%20router" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fshantanugoel.com%2f2017%2f03%2f13%2fbypass-isp-dns-hijack-ubiquiti-ubnt-usg%2f&title=Bypass%20ISP%20DNS%20hijack%20by%20changing%20DNS%20port%20on%20Ubiquiti%20USG%20router" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fshantanugoel.com%2f2017%2f03%2f13%2fbypass-isp-dns-hijack-ubiquiti-ubnt-usg%2f&description=Bypass%20ISP%20DNS%20hijack%20by%20changing%20DNS%20port%20on%20Ubiquiti%20USG%20router" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/2017/01/24/act-fibernet-deep-packet-inspection-blocking-sites/>ACT Fibernet blocks sites using deep packet inspection</a></li><li><a href=/2016/09/17/indian-isp-act-fibernet-blocks-bit-ly-does-dns-hijacking/>Indian ISP ACT Fibernet blocks bit.ly. Does DNS Hijacking</a></li><li><a href=/2010/08/13/android-permissions-malware/>Solving The Android Permissions And Malware Puzzle</a></li><li><a href=/2010/06/25/android-vs-iphone-security-models/>Android vs iPhone: Security Models</a></li><li><a href=/2008/05/16/fill-your-password-to-invite-your-buddies-not-so-fast/>Fill Your Password To Invite Your Buddies - Not So Fast!!</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://shantanugoel.com/2017/01/24/act-fibernet-deep-packet-inspection-blocking-sites/ data-toggle=tooltip data-placement=top title="ACT Fibernet blocks sites using deep packet inspection">&larr; Previous Post</a></li><li class=next><a href=https://shantanugoel.com/2017/04/03/email-actions-trigger-tasks-from-email-smtp-server/ data-toggle=tooltip data-placement=top title="email-actions: An SMTP server that triggers actions from email">Next Post &rarr;</a></li></ul><div class=disqus-comments><button id=show-comments class="btn btn-default" type=button>Show <span class=disqus-comment-count data-disqus-url=https://shantanugoel.com/2017/03/13/bypass-isp-dns-hijack-ubiquiti-ubnt-usg>comments</span></button><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url='https:\/\/shantanugoel.com\/2017\/03\/13\/bypass-isp-dns-hijack-ubiquiti-ubnt-usg';};</script></div></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:shantanu@shantanugoel.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/shantanugoel title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/shantanugoel title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">Shantanu Goel
&nbsp;&bull;&nbsp;&copy;
2017
&nbsp;&bull;&nbsp;
<a href=https://shantanugoel.com>Shantanu Vs The World</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.62.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
&nbsp;&bull;&nbsp;[<a href=https://github.com/shantanugoel/shantanugoel.com-source/commit/2ecd92e49e1289949594fa71d3a8406d50cc62ec>2ecd92e4</a>]</p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://shantanugoel.com/js/main.js></script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://shantanugoel.com/js/load-photoswipe.js></script><script type=text/javascript>$(function(){$('#show-comments').on('click',function(){var disqus_shortname='shantanugoel';(function(){var disqus=document.createElement('script');disqus.type='text/javascript';disqus.async=true;disqus.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(disqus);})();$(this).hide();});});</script><script id=dsq-count-scr src=//shantanugoel.disqus.com/count.js async></script></body></html>